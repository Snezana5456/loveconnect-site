<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoveConnect - Регистрация и Авторизация</title>
</head>
<body>
  <h2>LoveConnect</h2>

  <div id="auth-section">
    <input type="email" id="email" placeholder="Email" required /><br />
    <input type="password" id="password" placeholder="Пароль" required /><br />
    <input type="text" id="full_name" placeholder="Имя" /><br />
    <input type="date" id="birth_date" /><br />
    <select id="gender">
      <option value="male">Мужской</option>
      <option value="female">Женский</option>
      <option value="other">Другое</option>
    </select><br />
    <textarea id="bio" placeholder="О себе..." rows="4" cols="40"></textarea><br /><br />

    <button id="btnSignUp">Зарегистрироваться</button>
    <button id="btnSignIn">Войти</button>
    <button id="btnSignOut" style="display: none;">Выйти</button>
  </div>

  <hr />

  <div id="profile-section" style="display: none;">
    <h3>Профиль пользователя</h3>
    <p><strong>Имя:</strong> <span id="p_name"></span></p>
    <p><strong>Email:</strong> <span id="p_email"></span></p>
    <p><strong>Дата рождения:</strong> <span id="p_birth"></span></p>
    <p><strong>Пол:</strong> <span id="p_gender"></span></p>
    <p><strong>О себе:</strong><br /><span id="p_bio"></span></p>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://nokggxwhycdvjrrjkugej.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5va2dneHdoeWNkdmpyamt1Z2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4OTM4NTMsImV4cCI6MjA2OTQ2OTg1M30.h3FBLy-vFilgVcKKS_zXixBjRmYYSLFk94fIVQi_MwQ'
    )

    const emailInput = document.getElementById('email')
    const passwordInput = document.getElementById('password')
    const fullNameInput = document.getElementById('full_name')
    const birthDateInput = document.getElementById('birth_date')
    const genderInput = document.getElementById('gender')
    const bioInput = document.getElementById('bio')

    const signUpBtn = document.getElementById('btnSignUp')
    const signInBtn = document.getElementById('btnSignIn')
    const signOutBtn = document.getElementById('btnSignOut')

    const profileSection = document.getElementById('profile-section')

    signUpBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      const password = passwordInput.value.trim()
      const full_name = fullNameInput.value.trim()
      const birth_date = birthDateInput.value
      const gender = genderInput.value
      const bio = bioInput.value.trim()

      const { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email, password })

      if (signUpError) {
        alert('Ошибка регистрации: ' + signUpError.message)
        return
      }

      const userId = signUpData.user.id

      const { error: insertError } = await supabase.from('profiles').insert([{
        id: userId,
        full_name,
        birth_date,
        gender,
        bio
      }])

      if (insertError) {
        alert('Регистрация успешна, но не удалось сохранить профиль: ' + insertError.message)
      } else {
        alert('Регистрация и профиль сохранены!')
        await showProfile(userId, email)
      }
    })

    signInBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim()
      const password = passwordInput.value.trim()

      const { data, error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) {
        alert('Ошибка входа: ' + error.message)
        return
      }

      alert('Вы вошли!')
      signOutBtn.style.display = 'inline'
      await showProfile(data.user.id, email)
    })

    signOutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut()
      alert('Вы вышли.')
      signOutBtn.style.display = 'none'
      profileSection.style.display = 'none'
    })

    async function showProfile(userId, email) {
      const { data, error } = await supabase.from('profiles').select('*').eq('id', userId).single()

      if (error) {
        alert('Ошибка загрузки профиля: ' + error.message)
        return
      }

      document.getElementById('p_name').textContent = data.full_name || ''
      document.getElementById('p_email').textContent = email || ''
      document.getElementById('p_birth').textContent = data.birth_date || ''
      document.getElementById('p_gender').textContent = data.gender || ''
      document.getElementById('p_bio').textContent = data.bio || ''
      profileSection.style.display = 'block'
    }

    // Если пользователь уже залогинен — показываем профиль
    const checkUser = async () => {
      const { data: { user } } = await supabase.auth.getUser()
      if (user) {
        signOutBtn.style.display = 'inline'
        await showProfile(user.id, user.email)
      }
    }
    checkUser()
  </script>
</body>
</html>
